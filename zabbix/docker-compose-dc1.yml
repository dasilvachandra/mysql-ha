services:
  # One-shot init job (DC1)
  zbx-db-init-dc1:
    image: zabbix/zabbix-server-mysql:alpine-7.0-latest
    container_name: zbx-db-init-dc1
    env_file: [.env.dc1]
    entrypoint: ["/bin/sh","-lc"]
    command: >
      set -e;
      echo "[zbx-db-init-dc1] Waiting DB ${DB_SERVER_HOST}:${DB_SERVER_PORT}";
      until mysql -h${DB_SERVER_HOST} -P${DB_SERVER_PORT} -u${MYSQL_USER} -p${MYSQL_PASSWORD} -e "SELECT 1" ${MYSQL_DATABASE} >/dev/null 2>&1; do
        sleep 2; echo -n .; done; echo;
      cnt=$$(mysql -N -h${DB_SERVER_HOST} -P${DB_SERVER_PORT} -u${MYSQL_USER} -p${MYSQL_PASSWORD}
        -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='${MYSQL_DATABASE}'");
      echo "[zbx-db-init-dc1] Tables in ${MYSQL_DATABASE}: $$cnt";
      if [ "${FORCE_REIMPORT:-0}" = "1" ]; then cnt=0; fi;
      if [ "$$cnt" -lt 10 ]; then
        echo "[zbx-db-init-dc1] Importing schema...";
        zcat /usr/share/doc/zabbix-sql-scripts/mysql/schema.sql.gz | \
          mysql -h${DB_SERVER_HOST} -P${DB_SERVER_PORT} -u${MYSQL_USER} -p${MYSQL_PASSWORD} ${MYSQL_DATABASE};
        echo "[zbx-db-init-dc1] Importing images...";
        zcat /usr/share/doc/zabbix-sql-scripts/mysql/images.sql.gz | \
          mysql -h${DB_SERVER_HOST} -P${DB_SERVER_PORT} -u${MYSQL_USER} -p${MYSQL_PASSWORD} ${MYSQL_DATABASE};
        echo "[zbx-db-init-dc1] Importing data...";
        zcat /usr/share/doc/zabbix-sql-scripts/mysql/data.sql.gz | \
          mysql -h${DB_SERVER_HOST} -P${DB_SERVER_PORT} -u${MYSQL_USER} -p${MYSQL_PASSWORD} ${MYSQL_DATABASE};
        echo "[zbx-db-init-dc1] Done.";
      else
        echo "[zbx-db-init-dc1] Database already initialized; skip.";
      fi
    restart: "no"
    networks: [zbx_net_dc1]

  zabbix-server-dc1:
    build:
      context: .
      dockerfile: ./Dockerfile.server
    container_name: zbx-server-dc1
    depends_on: [zbx-db-init-dc1]
    env_file: [.env.dc1]
    environment:
      ZBX_DEBUGLEVEL: ${ZBX_DEBUGLEVEL}
      TZ: ${TZ}
    ports:
      - "10051:10051"
    volumes:
      - zbx_srv_data_dc1:/var/lib/zabbix
      - zbx_srv_log_dc1:/var/log/zabbix
    restart: unless-stopped
    logging:
      driver: json-file
      options: { max-size: "10m", max-file: "5" }
    networks: [zbx_net_dc1]

  zabbix-web-dc1:
    build:
      context: .
      dockerfile: ./Dockerfile.web
    container_name: zbx-web-dc1
    depends_on: [zabbix-server-dc1]
    env_file: [.env.dc1]
    environment:
      ZBX_SERVER_HOST: zabbix-server-dc1
      PHP_TZ: ${TZ}
      TZ: ${TZ}
    ports:
      - "8080:8080"   # DC1 web UI
    volumes:
      - zbx_web_log_dc1:/var/log/nginx
    restart: unless-stopped
    logging:
      driver: json-file
      options: { max-size: "10m", max-file: "5" }
    networks: [zbx_net_dc1]

networks:
  zbx_net_dc1:
    name: zbx_net_dc1

volumes:
  zbx_srv_data_dc1:
  zbx_srv_log_dc1:
  zbx_web_log_dc1:
